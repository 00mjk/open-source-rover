\documentclass[12pt]{article}
\usepackage[margin=1in]{geometry}
\usepackage{setspace}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{amsmath}
\usepackage{color}
\usepackage{hyperref}
\usepackage{multicol}
\usepackage{gensymb}
\usepackage{framed}
\usepackage[dvipsnames]{xcolor}
\usepackage{xcolor}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{fancyhdr}
\usepackage{verbatim}
\pagestyle{fancy}
\lfoot{\textbf{Open Source Rover Software Install}}
\rfoot{Page \thepage}
\lhead{\textbf{\leftmark}}
\rhead{\textbf{\rightmark}}
\cfoot{}
\renewcommand{\footrulewidth}{1.8pt}
\renewcommand{\headrulewidth}{1.8pt}
\doublespacing
\setlength{\parindent}{1cm}

\begin{document}

\title{Open Source Rover: Software Instructions}
\author{Author: Eric Junkins}

\makeatletter         
\def\@maketitle{
\begin{center}	
	\makebox[\textwidth][c]{ \includegraphics[width=0.8\paperwidth]{"Pictures/software title".png}}
	{\Huge \bfseries \sffamily \@title }\\[3ex] 
	{\Large\sffamily \@author}\\[3ex] 
	\includegraphics[width=.85\linewidth]{"Pictures/JPL logo".png}
\end{center}}
\makeatother

\maketitle

\noindent {\footnotesize Reference herein to any specific commercial product, process, or service by trade name, trademark, manufacturer, or otherwise, does not constitute or imply its endorsement by the United States Government or the Jet Propulsion Laboratory, California Institute of Technology.}

\noindent {\footnotesize \textcopyright  2018 California Institute of Technology. Government sponsorship acknowledged}

% Introduction
\newpage


\tableofcontents

\newpage


\section{Setting up the Raspberry Pi 3}
In this section we'll go over setting up the Raspberry Pi and how to get all the code to run the rover going, as well as setting up the bluetooth pairing from the android device.
\subsection{Getting the Raspberry Pi online}

The best way to get started with Raspberry Pi if you are unfamiliar with them is to follow the "Getting started with Raspberry Pi" tutorial which can be found at:

\begin{enumerate}
	\item[] \href{https://projects.raspberrypi.org/en/projects/raspberry-pi-getting-started}{https://projects.raspberrypi.org/en/projects/raspberry-pi-getting-started}
\end{enumerate} 

\subsection{Downloading the Rover Code}
On the Raspberry Pi open up a terminal \textbf{(ctl + alt + t)} and then type the following commands \footnote{In this document terminal commands will be \colorbox{lightgray}{highlighted}}:

\begin{itemize}
	\item[] \colorbox{lightgray}{cd /home/pi}
	\item[] \colorbox{lightgray}{git clone https://github.jpl.nasa.gov/ejunkins/osr\_rover\_code}
	\item[] \textcolor{red}{THIS LINK TO CHANGE UPON RELEASE}
\end{itemize}

%For instructions on getting the raspberry pi OS downloaded and installed visit the following link:
%
%\begin{itemize}
%	\item \href{https://www.raspberrypi.org/documentation/installation/noobs.md}{https://www.raspberrypi.org/documentation/installation/noobs.md}
%\end{itemize}
%
%\subsubsection{Getting the Rover code:}
%\textcolor{red}{The following are the instructions on how to get the rover code for the beta groups, this will change for the final release}. 
%\begin{itemize}
%	\item Download id\_rsa text file from the google drive, and move it to ~/.ssh on 
%	\begin{itemize}
%		\item On a Raspberry pi open up a terminal (ctrl + alt + t) and type: 
%		\item cp ~/home/pi/Downloads/id\_rsa ~/.ssh	
%	\end{itemize}
%	\item Open up a terminal (ctrl + alt + t) and type the following commands:
%	\begin{itemize}
%		\item cd ~/home/pi/Desktop
%		\item mkdir osr
%		\item cd osr
%		\item git init
%		\item git pull git@github.com:ericjunkins/OSR.git
%		\item if prompted type "yes"
%		\item Passkey is: rover
%	\end{itemize}
%
%\end{itemize}

\subsubsection{Installing packages}
Below are the packages you will need to use Bluetooth communication through the raspberry pi. Open up a terminal on the Raspberry Pi  and type the following commands:
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo apt-get update}
	\item[] \colorbox{lightgray}{sudo apt-get upgrade}
	\item[] \colorbox{lightgray}{sudo apt-get install python-bluez}
	\item[] \colorbox{lightgray}{sudo apt-get install python-pip python-dev ipython}
	\item[] \colorbox{lightgray}{sudo apt-get install bluetooth libbluetooth-dev}
	\item[] \colorbox{lightgray}{sudo pip install pybluez}
	\item[] \colorbox{lightgray}{sudo systemctl start bluetooth}

\end{itemize}

\noindent Now you need modify a line of code in the Bluetooth service file, start by typing:
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo nano /lib/systemd/system/bluetooth.service}
\end{itemize}
\noindent Add "-C" after 'bluetoothd' on line 9, the file should look like the Figure \ref{bs}:

\begin{figure}[H]
 	\centering
	\includegraphics[width=1\textwidth]{"Pictures/bluetooth service".PNG}
	\caption{bluetooth.service File}
	\label{bs}
\end{figure}
	
\noindent Once you have done this exit and save (ctrl + x, y, enter), and then reboot the Pi. Once rebooted open up a terminal and type
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo sdptool add SP}
\end{itemize}


\section{Control Method}

The first thing to do is select which control method you want to use. There are two ways that are built into the code already to control the rover, one of which is a Bluetooth app run on Android devices, and the other is using a wireless Xbox controller. 

\begin{figure}[H]
 	\centering
	\includegraphics[width=.7\textwidth]{"Pictures/control".PNG}
 	\caption{Control Methods}
	\label{controls}
\end{figure}

\noindent Any way that you can communicate to a Raspberry Pi is a way that you can control the rover, and we fully encourage finding and developing other methods of remote control. For these methods if you decide to use an Android device you will need to follow some steps to get the app loaded on your phone, as we provide the source code so you can edit and change things the next section will walk you through getting the source code.

\subsection{Android App Control}
If you choose to control the rover from an Android App you'll need to setup Bluetooth communication between the Raspberry Pi and Android device. There are a few different methods of doing this, we'll be using a terminal interface to do this in this tutorial.

\subsubsection{Naming the Bluetooth Device}

On the Raspberry Pi create a file that will name the Bluetooth device your desired name \footnote{This name must also be updated in the Android App such that the App finds the correct device, so make sure to keep track of this name}. First on the RPi in a terminal type 
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo nano /etc/machine-info} 
\end{itemize}
\noindent Name your device by by replacing deviceName with want the name of your Raspberry Pi to be:

\begin{figure}[H]
 	\centering
	\includegraphics[width=.5\textwidth]{"Pictures/devicename".PNG}
\end{figure}

\noindent Now edit the maain.conf file, Uncomment the "Name=" line and add your deviceName. 
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo nano /etc/bluetooth/main.conf} 
\end{itemize}

\noindent The first few lines should look like Figure \ref{conf}.

\begin{figure}[H]
 	\centering
	\includegraphics[width=1\textwidth]{"Pictures/mainconf".PNG}
	\caption{bluetooth main.conf File}
	\label{conf}
\end{figure}

\subsubsection{Pairing Bluetooth from Commandline}
We're now ready to pair the device with your android device. We followed along with the following tutorial to learn how to do this:

\begin{itemize}
	\item \href{https://www.cnet.com/how-to/how-to-setup-bluetooth-on-a-raspberry-pi-3/}{https://www.cnet.com/how-to/how-to-setup-bluetooth-on-a-raspberry-pi-3/}
\end{itemize}

Have your android phone discover-able and searching for Bluetooth \footnote{For individual phones look up instructions on google if necessary to do this}. Begin by in a terminal starting the bluetoothctl
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo bluetoothctl}
\end{itemize}

\noindent Now in that bluetoothctl terminal do the following commands:

\begin{itemize}
	\item[] \colorbox{lightgray}{agent on}
	\item[] \colorbox{lightgray}{default-agent}
	\item[] \colorbox{lightgray}{scan on}
\end{itemize}

\noindent Once your find your device you'll need to pair to it from its' Address.

\begin{itemize} 	
	\item[] \colorbox{lightgray}{pair XX:XX:XX:XX:XX:XX} 
	\item[] \colorbox{lightgray}{yes}
\end{itemize}
	
\noindent You'll be prompted on the phone asking to accept the pairing, select okay, and then on the Raspberry Pi now that you have paired the devices quit the bluetoothctl.
\begin{itemize}
	\item[] \colorbox{lightgray}{quit} 
\end{itemize}

\subsubsection{Downloading the Android App}

To begin you need to download Android Studio, which will allow you to put the source code onto the android device \footnote{This is to be done on a laptop or desktop computer, not the Raspberry Pi}.

\begin{itemize}
	\item \href{https://developer.android.com/studio/index.html}{https://developer.android.com/studio/index.html}
\end{itemize}

\noindent In order to allow the android device to be able to have source code loaded onto it you'll need to enable USB debugging, which is going to be different for a lot of different version of phones. The best way to figure this out is to google "android USB debugging" for your specific device and follow the steps there. Android studio also provides lots of support information and forums to help getting through any problems and issues had on that end, consult those if there are issues.

\bigskip

\noindent To get the code for the app you can run the following command in a terminal at the location you desire it to be put:

\begin{itemize}
	\item[] \colorbox{lightgray}{git clone https://github.jpl.nasa.gov/ejunkins/osr\_android\_app}
	\item[] \textcolor{red}{THIS LINK TO CHANGE UPON RELEASE TO FINAL LINK LOCATION}
\end{itemize}

\noindent Or you can navigate to the URL at:

\begin{itemize}
	\item[] \href{https://github.jpl.nasa.gov/ejunkins/osr_android_app}{https://github.jpl.nasa.gov/ejunkins/osr\_android\_app}
	\item[] \textcolor{red}{THIS LINK TO CHANGE UPON RELEASE TO FINAL LINK LOCATION}
\end{itemize}

\noindent and under the Clone or download button click Download ZIP and extract the files in that manner. 

\bigskip

\noindent Now open up the source code just downloaded in Android Studio. In order for the App to communicate to the Raspberry Pi you'll need to make sure it selects the correct Bluetooth device, on line 198 in the MainActivity.java file change the variable \textit{connection\_name} to be equal to whatever you named the Raspberry Pi in the previous section. Now hit run in the upper panel, and the android app should build and load onto your device. 

\begin{figure}[H]
 	\centering
	\includegraphics[width=.7\textwidth]{"Pictures/autorun".PNG}
 	\caption{}
	\label{}
\end{figure}


\subsection{Init Script}
We will want the code on the rover to run when the pi boots up, so we will add that to an init script, which on Raspberry Pi can be found at /etc/rc.local. In a terminal type
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo nano /etc/rc.local}
\end{itemize}
\noindent The following lines are added after the "if" block, as shown in Figure \ref{init}. This example is to run with the LED screen, and from an Xbox controller.

\begin{verbatim}
sudo python /home/pi/osr/led/screen.py &
sleep 10
sudo python /home/pi/osr/rover/main.py -s -c x &
\end{verbatim}

\begin{figure}[H]
 	\centering
	\includegraphics[width=1\textwidth]{"Pictures/init".PNG}
 	\caption{Init Script}
	\label{init}
\end{figure}

The command line args it accepts are the following:

\begin{itemize}
	\item[] \textbf{-t} : Testing mode - allows you to emulate a controller from the terminal for testing and control of the robot. 
	\item[] \textbf{-s} : Attempts to connect to the Unix Socket running in the LED screen script to send commands between the two processes
	\item[] \textbf{-c} : Controller flag, tells which controller should be listened for
	\begin{itemize}
		\item [] \textbf{b} : Bluetooth app (default)
		\item [] \textbf{x} : Xbox controller
	\end{itemize} 	

\end{itemize}

If you wish to run without the LED screen do not put the line starting the \textit{screen.py} into the init script, and do not run with the \textit{-s} flag.

\subsection{Setting up serial communication}	

In this project we will be using serial communication to talk to the motor controllers. This is a communication protocol that describes how bits of information will be transferred between one device and another. More information on this can be found at:
\begin{itemize}
	\item \href{https://learn.sparkfun.com/tutorials/serial-communication}{https://learn.sparkfun.com/tutorials/serial-communication}
\end{itemize}

\noindent Do the following to setup/enable the serial communication for the RoboClaws:
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo raspi-config}
\end{itemize}

\noindent In this menu navigate and do the following commands:
\begin{itemize}
	\item[-]  Interface Options $-> $ Serial 
	\item[-] Would you like a login shell to be accessible over serial? $->$ No
	\item[-] Would you like the serial port hardware to be enabled? $->$ Yes
	\item[-] Would you like to reboot now? $->$ Yes
\end{itemize} 
\noindent Once rebooted open up a terminal again and look at the serial devices	
\begin{itemize}
	\item[] \colorbox{lightgray}{ls -l /dev/serial*}
\end{itemize}
Make sure that this says: serial0 -$>$ ttyS0 . Now we have to edit the cmdline.txt file. In a terminal type
\begin{itemize}
	\item [] \colorbox{lightgray}{sudo nano /boot/cmdline.txt}
\end{itemize}

\noindent Edit \textbf{ONLY} the part with "console = ....", change it to be "console=tty1" and remove any other instance where it references console. The first bit of that line should look similar to the Figure \ref{console} \footnote{If it does not exactly match this it is fine, the import part is the "console=tty1" section}:

\begin{figure}[H]
 	\centering
	\includegraphics[width=1\textwidth]{"Pictures/console".PNG}
 	\caption{boot/cmdline.txt File}
	\label{console}
\end{figure}

\noindent Here is a link to help with this process if necessary.
\begin{itemize}
	\item \href{https://spellfoundry.com/2016/05/29/configuring-gpio-serial-port-raspbian-jessie-including-pi-3/}{https://spellfoundry.com/2016/05/29/configuring-gpio-serial-port-raspbian-jessie-including-pi-3/}. 
\end{itemize}
\noindent Once this is all done then reboot the pi.
\begin{itemize}
	\item[] \colorbox{lightgray}{sudo reboot}
\end{itemize}


\section{Test files}
There are a few files that will help you test the robot before trying to fully drive it. These working will not fully guarantee everything will work but is supposed to help with the testing and debugging process.

\subsection{Serial Test}

Under the 'rover' folder there is a script called \textit{serialTest.py}. This will help you test the serial communication of the Raspberry Pi. To begin use a jumper wire between pin 14 and 15. 

\begin{figure}[H]
 	\centering
	\includegraphics[width=.7\textwidth]{"Pictures/rpi pins".PNG}
 	\caption{Raspberry Pi pinout}
	\label{rpi pin}
\end{figure}


Then in a terminal run the script:
\begin{itemize}
	\item[] \colorbox{lightgray}{python /home/pi/osr/rover/serialTest.py}
\end{itemize}

If the serial communication is working properly then this will let you know it sucessfully read data over the serial pins. If it does not then recheck you have followed all the steps in this doc to get serial communication working, and that you are connecting GPIO pins 14 and 15 together. 
\end{document}